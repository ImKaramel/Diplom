# Diplom

## Обзор
Этот проект реализует прогнозирование временных рядов потребления энергии с использованием моделей: ARIMA (статистическая модель), N-BEATS (глубокая нейронная сеть) и XGBoost (градиентный бустинг). Проект включает предобработку данных, обучение моделей, прогнозирование и оценку результатов. Цель — предсказать потребление энергии (`A_plus`) для разных групп (`uuid`) на заданных горизонтах прогнозирования.

Проект организован модульно и управляется через конфигурационный файл `config.yaml`.

## Структура Проекта
Проект организован в следующие директории и ключевые файлы:

- **`/src/`**: Исходный код проекта.
    - **`preprocessing/`**: Модули для предобработки данных.
        - `missing_value_handler.py`: Обработка пропусков в данных.
        - `anomaly_fix.py`: Выявление и устранение аномалий.
        - `norm_fix.py`: Нормализация и денормализация данных.
    - **`forecasting/`**: Модули для прогнозирования.
        - `nbeats_model.py`: Определяет класс для инициализации модели N-BEATS.
        - `arima_model.py`: Определяет класс для прогнозирования с ARIMA.
        - `xgboost_model.py`: Определяет класс для прогнозирования с XGBoost.
        - `evaluation.py`: Содержит функции `forecast_arima`, `forecast_nbeats` и `forecast_xgboost` для обучения моделей и прогнозирования.
    - **`main.py`**: Точка входа в проект.

- **`/data/`**: Директория для хранения данных.
    - **`raw/`**: Исходные данные (не включены в репозиторий).
    - **`processed/`**: Обработанные данные.
        - `clean_data_knn_rf_minmax.csv`: Предобработанные данные (результат этапа предобработки).
        - `norm_params.json`: Хранит параметры нормализации (min и max значения) для каждой группы.

- **`/graphics/`**: Директория для сохранения графиков (например, ACF/PACF).

- **`/logs/`**: Логи выполнения проекта.
    - `project.log`: Лог-файл с информацией о выполнении.

- **`/config/`**: Конфигурационные файлы.
    - `config.yaml`: Основной файл конфигурации проекта.

## Предобработка
Этап предобработки включает:
- **Обработку пропусков**: Заполнение отсутствующих значений с использованием методов линейной интерполяции, сезонной интерполяции или KNN.
- **Обработку аномалий**: Выявление и устранение аномалий с использованием методов на основе STL или случайного леса (Random Forest).
- **Нормализация**: Приведение данных к единому масштабу 
- **Анализ временных рядов**

Предобработанные данные сохраняются в `clean_data_knn_rf_minmax.csv`. (в зависимости от методов)

## Прогнозирование
Этап прогнозирования использует предобработанные данные для обучения моделей и генерации прогнозов:
- **Модели**:
    - **ARIMA**: Статистическая модель, реализованная с использованием `statsmodels`. 
    - **N-BEATS**: Глубокая модель машинного обучения, реализованная с использованием библиотеки `darts`.  
    - **XGBoost**: Модель градиентного бустинга, реализованная с использованием библиотеки `xgboost`.
- **Процесс**:
    - Данные делятся на тренировочные (80%) и тестовые (20%) наборы.
    - Выполняется кросс-валидация для оценки производительности моделей на разных горизонтах прогнозирования.
    - Генерируются финальные прогнозы для каждой группы и сохраняются в `data/forecasts/forecasts.csv`.
- **Оценка**: Модели оцениваются с использованием метрик MAE (средняя абсолютная ошибка) и RMSE (корень из средней квадратичной ошибки).
- **Денормализация**: Прогнозируемые значения денормализуются с использованием параметров из `norm_params.json` для возвращения к исходному масштабу.

## Запуск Проекта
Проект запускается через `main.py`. Он управляет как предобработкой, так и прогнозированием.

### Команда для Запуска
```bash
python src/main.py
```

### Выполняемые Шаги
1. **Загрузка Конфигурации**: Загружает `config.yaml` из `/config/`.
2. **Предобработка**:
    - Если `clean_data_knn_rf_minmax.csv` отсутствует, выполняется предобработка и сохраняется результат.
    - Если файл существует, предобработка пропускается, и загружаются предобработанные данные.
3. **Прогнозирование**:
    - Выполняется прогнозирование с использованием выбранной модели (ARIMA, N-BEATS или XGBoost).
    - Результаты сохраняются в `data/forecasts/forecasts.csv`.

## Конфигурация (`config.yaml`)
Файл `config.yaml` управляет поведением проекта. Ниже приведены ключевые параметры и их назначение:

- **`data`**:
    - `raw`: Путь к файлу с исходными данными  
    - `processed`: Путь для сохранения предобработанных данных 
    - `norm_params`: Путь для сохранения параметров нормализации 
    - `forecasts`: Путь для сохранения результатов прогнозов

- **`preprocessing`**:
    - `target_column`: Целевая переменная для анализа и прогнозирования (`"A_plus"`).
    - `period`: Периодичность данных для сезонного анализа  
    - `miss_method`: Метод заполнения пропусков (`"linear"`, `"seasonal"`, `"knn"`).
    - `anom_method`: Метод выявления аномалий (`"stl"` или `"rf"` для STL-разложения или случайного леса).
    - `anom_act`: Действие с аномалиями (`"mixed"` — комбинация методов).
    - `norm_method`: Метод нормализации (`"minmax"`, `"log"`, `"user_minmax"`).
    - `k`: Количество соседей для KNN-метода заполнения пропусков  
    - `thresh`: Порог для определения аномалий 
    - `rf_n_estimators`: Количество деревьев в случайном лесу для метода аномалий  
    - `lookback`: Окно ретроспективы для анализа (например, `168` часов = 7 дней).
    - `process_missing`: Включение обработки пропусков (`true` или `false`).
    - `process_anomalies`: Включение обработки аномалий (`true` или `false`).
    - `process_normalization`: Включение нормализации (`true` или `false`).

- **`forecasting`**:
    - `model`: Выбор модели для прогнозирования (`"arima"`, `"nbeats"`, `"xgboost"`).
    - `horizon`: Основной горизонт прогнозирования в часах (например, `168` часов = 7 дней).
    - `horizons`: Список горизонтов для кросс-валидации 
    - **`arima`**:
        - `order`: Начальные параметры ARIMA (p, d, q) 
        - `auto`: Автоматический подбор параметров ARIMA (`true` или `false`).
        - `s`: Сезонный период  
    - **`nbeats`**:
        - `num_stacks`: Количество стеков в модели N-BEATS 
        - `num_blocks`: Количество блоков в каждом стеке  
        - `num_layers`: Количество слоев в каждом блоке  
        - `layer_widths`: Ширина слоев 
        - `n_epochs`: Количество эпох обучения  
    - **`xgboost`**:
        - `n_estimators`: Количество деревьев в модели XGBoost 
        - `max_depth`: Максимальная глубина деревьев  
        - `learning_rate`: Скорость обучения  
        - `gamma`: Минимальное уменьшение функции потерь для разделения
        - `lambda`: L2-регуляризация

## Вывод
- **Прогнозы**: Результаты прогнозов сохраняются в `data/forecasts/forecasts.csv`. Файл содержит:
    - `time_dt`: Временная метка прогноза.
    - `group`: Идентификатор группы (`uuid`).
    - `forecast`: Предсказанное значение (денормализованное).
    - `lower_ci` и `upper_ci`: Доверительные интервалы (доступно только для ARIMA).
